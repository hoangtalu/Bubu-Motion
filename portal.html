<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BUBU Setup</title>
<style>
  :root {
    --eye-width: 100px;
    --eye-height: 100px;
    --eye-gap: 25px;
    --text-color: #fff;
    --bg: #000;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    width: 100vw;
    height: 100vh;
    background: var(--bg);
    color: var(--text-color);
    font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .layer {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  #message {
    position: absolute;
    top: 18%;
    width: 90%;
    max-width: 320px;
    text-align: center;
    font-size: 18px;
    letter-spacing: 0.5px;
    opacity: 0;
    transition: opacity var(--text-fade) linear;
    z-index: 3;
    pointer-events: none;
  }
  #eyes {
    gap: var(--eye-gap);
    z-index: 2;
    opacity: 0;
    transition: opacity var(--eyes-fade) linear;
  }
  .eye {
    width: var(--eye-width);
    height: var(--eye-height);
    background: #fff;
    border-radius: 16px;
    transform-origin: center;
  }
  .blink {
    animation: blink var(--blink-duration) ease-in-out forwards;
  }
  @keyframes blink {
    0% { transform: scaleY(1); }
    45% { transform: scaleY(0.08); }
    100% { transform: scaleY(1); }
  }
  #bubbles {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
  }
  .bubble {
    position: absolute;
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 6px;
    font-size: 12px;
    opacity: 0;
    transform: translateY(0);
    pointer-events: auto;
  }
  .bubble.show {
    animation: bubbleFadeIn var(--bubble-fade) ease forwards,
               bubbleFloat var(--bubble-float) ease-in-out infinite alternate;
  }
  .bubble.dim { opacity: 0.3 !important; }
  .bubble.selected {
    transition: transform 300ms ease, opacity 200ms linear;
    transform: translate(-50%, -50%) scale(1);
    left: 50% !important;
    top: 50% !important;
    z-index: 4;
  }
  .bubble.pulsing {
    animation: bubblePulse var(--connect-pulse) ease-in-out infinite;
  }
  @keyframes bubbleFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes bubbleFloat {
    from { transform: translateY(0); }
    to { transform: translateY(-10px); }
  }
  @keyframes bubblePulse {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.15); }
    100% { transform: translate(-50%, -50%) scale(1); }
  }
  #form {
    position: absolute;
    top: 65%;
    width: 80%;
    max-width: 320px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms ease;
    z-index: 4;
  }
  #form.show {
    opacity: 1;
    pointer-events: auto;
  }
  input, button {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.06);
    color: #fff;
    border-radius: 6px;
    font-size: 14px;
  }
  button {
    border: 1px solid rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.12);
  }
  #successText {
    position: absolute;
    top: 18%;
    width: 90%;
    max-width: 320px;
    text-align: center;
    font-size: 18px;
    letter-spacing: 0.5px;
    opacity: 0;
    z-index: 3;
    pointer-events: none;
  }
  @keyframes eyesPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
</style>
</head>
<body>
  <div id="message">HELLO! ARE YOU GOING TO SHOW ME THE WORLD?</div>

  <div id="eyes" class="layer">
    <div class="eye"></div>
    <div class="eye"></div>
  </div>

  <div id="bubbles"></div>

  <div id="form">
    <input id="password" type="password" placeholder="Password (leave blank if open)">
    <button id="connectBtn" type="button">Connect</button>
  </div>

  <div id="successText">WOW! THANKS!</div>

<script>
const TIMING = {
  EYES_FADE_IN: 800,
  BLINK_DURATION: 160,
  BLINK_GAP: 220,
  TEXT_FADE_IN: 700,
  BUBBLE_FADE_IN: 600,
  BUBBLE_FLOAT_PERIOD: 6000,
  CONNECT_PULSE_PERIOD: 900
};

// Derived CSS variables for consistency
document.documentElement.style.setProperty('--eyes-fade', `${TIMING.EYES_FADE_IN}ms`);
document.documentElement.style.setProperty('--blink-duration', `${TIMING.BLINK_DURATION}ms`);
document.documentElement.style.setProperty('--text-fade', `${TIMING.TEXT_FADE_IN}ms`);
document.documentElement.style.setProperty('--bubble-fade', `${TIMING.BUBBLE_FADE_IN}ms`);
document.documentElement.style.setProperty('--bubble-float', `${TIMING.BUBBLE_FLOAT_PERIOD}ms`);
document.documentElement.style.setProperty('--connect-pulse', `${TIMING.CONNECT_PULSE_PERIOD}ms`);

const STATES = {
  INTRO: 'INTRO',
  EYES_VISIBLE: 'EYES_VISIBLE',
  TEXT_VISIBLE: 'TEXT_VISIBLE',
  WIFI_SELECTION: 'WIFI_SELECTION',
  PASSWORD_INPUT: 'PASSWORD_INPUT',
  CONNECTING: 'CONNECTING',
  SUCCESS: 'SUCCESS'
};

let state = STATES.INTRO;
let bubbles = [];
let selectedBubble = null;
const eyesEl = document.getElementById('eyes');
const messageEl = document.getElementById('message');
const bubblesEl = document.getElementById('bubbles');
const formEl = document.getElementById('form');
const passwordEl = document.getElementById('password');
const connectBtn = document.getElementById('connectBtn');
const successTextEl = document.getElementById('successText');

function setState(next) {
  console.log('State ->', next);
  state = next;
}

function wait(ms) {
  return new Promise(res => setTimeout(res, ms));
}

async function runIntro() {
  setState(STATES.INTRO);
  // Eyes fade in
  eyesEl.style.opacity = '1';
  await wait(TIMING.EYES_FADE_IN);
  setState(STATES.EYES_VISIBLE);
  // Blink twice sequentially
  await doBlinkSequence(2);
  // Text fade in
  messageEl.style.opacity = '1';
  await wait(TIMING.TEXT_FADE_IN);
  setState(STATES.TEXT_VISIBLE);
  await startWifiSelection();
}

async function doBlinkSequence(count) {
  const eyes = Array.from(document.querySelectorAll('.eye'));
  for (let i = 0; i < count; i++) {
    eyes.forEach(e => {
      e.classList.remove('blink');
      // force reflow to restart animation
      void e.offsetWidth;
      e.classList.add('blink');
    });
    await wait(TIMING.BLINK_DURATION + TIMING.BLINK_GAP);
  }
}

function mapRssiToSize(rssi) {
  const minRssi = -90;
  const maxRssi = -30;
  const clamped = Math.max(minRssi, Math.min(maxRssi, rssi));
  const t = (clamped - minRssi) / (maxRssi - minRssi);
  return 40 + t * (110 - 40);
}

async function fetchNetworks() {
  try {
    const res = await fetch('/scan');
    if (!res.ok) throw new Error('scan failed');
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  } catch (e) {
    console.warn('Scan failed, using fallback', e);
    return [];
  }
}

function placeBubbles(networks) {
  bubbles = [];
  bubblesEl.innerHTML = '';
  const w = window.innerWidth;
  const h = window.innerHeight;

  const taken = [];
  networks.slice(0, 8).forEach(net => {
    const size = mapRssiToSize(net.rssi || -80);
    let x = 0, y = 0, attempts = 0;
    const radius = size / 2;
    const margin = 20;
    do {
      x = margin + radius + Math.random() * (w - 2 * (margin + radius));
      y = margin + radius + Math.random() * (h - 2 * (margin + radius));
      attempts++;
    } while (attempts < 15 && taken.some(p => {
      const dx = p.x - x;
      const dy = p.y - y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      return dist < (p.r + radius + 12);
    }));
    taken.push({ x, y, r: radius });

    const div = document.createElement('div');
    div.className = 'bubble';
    div.style.width = `${size}px`;
    div.style.height = `${size}px`;
    div.style.left = `${x - radius}px`;
    div.style.top = `${y - radius}px`;
    div.textContent = net.ssid || '(hidden)';
    div.dataset.ssid = net.ssid || '';
    div.dataset.rssi = net.rssi || '';
    bubblesEl.appendChild(div);
    bubbles.push(div);
  });
}

function showBubbles() {
  bubbles.forEach(b => {
    b.classList.add('show');
    b.addEventListener('click', () => handleBubbleSelect(b));
  });
}

async function startWifiSelection() {
  setState(STATES.WIFI_SELECTION);
  const nets = await fetchNetworks();
  nets.sort((a, b) => (b.rssi || -999) - (a.rssi || -999));
  placeBubbles(nets.slice(0, 8));
  showBubbles();
}

function handleBubbleSelect(el) {
  if (state !== STATES.WIFI_SELECTION && state !== STATES.PASSWORD_INPUT) return;
  selectedBubble = el;
  setState(STATES.PASSWORD_INPUT);
  bubbles.forEach(b => {
    if (b !== el) b.classList.add('dim');
  });
  el.classList.add('selected');
  formEl.classList.add('show');
  passwordEl.focus();
}

async function handleConnect() {
  if (!selectedBubble) return;
  setState(STATES.CONNECTING);
  selectedBubble.classList.add('pulsing');
  connectBtn.disabled = true;
  const payload = {
    ssid: selectedBubble.dataset.ssid,
    pass: passwordEl.value || ''
  };
  try {
    const res = await fetch('/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `ssid=${encodeURIComponent(payload.ssid)}&pass=${encodeURIComponent(payload.pass)}`
    });
    if (!res.ok) throw new Error('connect failed');
    await showSuccess();
  } catch (e) {
    console.warn('Connect failed', e);
    connectBtn.disabled = false;
    selectedBubble.classList.remove('pulsing');
    setState(STATES.PASSWORD_INPUT);
  }
}

async function showSuccess() {
  setState(STATES.SUCCESS);
  // Fade out bubbles and form
  bubbles.forEach(b => b.style.opacity = '0');
  formEl.classList.remove('show');
  // Eyes subtle pop
  eyesEl.style.animation = `eyesPop 400ms ease`;
  await wait(400);
  eyesEl.style.animation = '';
  // Update text
  messageEl.style.opacity = '0';
  await wait(200);
  successTextEl.style.opacity = '1';
}

connectBtn.addEventListener('click', handleConnect);

window.addEventListener('load', () => {
  runIntro();
});
</script>
</body>
</html>
